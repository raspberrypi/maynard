#! /bin/bash

PREFIX=@prefix@
LIBEXECDIR=$PREFIX/libexec
ABS_BUILDDIR=@abs_builddir@
DEFAULT_BACKGROUND=/usr/share/wallpapers/Hanami/contents/images/3872x2592.jpg

md5() {
    cat "$1" 2> /dev/null | md5sum
}

check_install() {
    local_maynard="$ABS_BUILDDIR/shell/maynard"
    installed_maynard="$LIBEXECDIR/maynard"
    if [ ! -e "$local_maynard" -o \
         ! -e "$installed_maynard" -o \
         "`md5 \"$local_maynard\"`" != "`md5 \"$installed_maynard\"`" ]; then
        echo "It looks like you forgot to run 'make install'." >&2
        exit 1
    fi
}

check_group_membership() {
        group_membership=$(groups $USER);
        if [[ $group_membership != *weston-launch* ]]; then
            echo "Missing weston-launch group membership for $USER. Try"
            echo ""
        echo "    sudo adduser $USER weston-launch"
            echo ""
            exit 1
        fi
        if [[ $group_membership != *video* ]]; then
            echo "Missing video group membership for $USER. Try"
            echo ""
            echo "    sudo adduser $USER video"
            echo ""
            exit 1 
        fi
        if [[ $group_membership != *audio* ]]; then
            echo "Missing audio group membership for $USER. Try"
            echo ""
            echo "    sudo adduser $USER audio"
            exit 1 
        fi
    }   

mkdir ~/.config > /dev/null 2>&1

if [ -z "${MAYNARD_BACKGROUND+_}" -a \
     -e "$DEFAULT_BACKGROUND" ]; then
    export MAYNARD_BACKGROUND="$DEFAULT_BACKGROUND"
fi

xdpyinfo > /dev/null 2>&1
if [ "$?" = "0" ]; then
    # We are running under X, so let's assume this is a development
    # installation.
    if ! cat /etc/os-release 2> /dev/null | grep 'ID=raspbian' > /dev/null; then
        # Non-Raspbian, we can launch weston under X.
        check_install
        XDG_DATA_DIRS=$XDG_DATA_DIRS:$PREFIX/share/ $PREFIX/bin/weston
    else
        echo "You cannot run Maynard under X." >&2
        exit 1
    fi
else
    check_group_membership
    weston-launch
fi
